name: CI
on: [push]

jobs:
  setup_and_test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        php-version: [7.4]
        moodle-version: ["MOODLE_401_STABLE"]
        plugin-repo: ["https://github.com/Lysa14/moodle-local_cnw_smartcohort.git"]
        plugin-name: ["cnw_smartcohort"]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}

      - name: Install Composer
        run: |
          mkdir -p bin
          php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
          php composer-setup.php --install-dir=bin --filename=composer
          php -r "unlink('composer-setup.php');"


      - name: Download Moodle
        run: |
          mkdir moodle
          wget https://github.com/moodle/moodle/archive/${{ matrix.moodle-version }}.zip
          unzip ${{ matrix.moodle-version }}.zip
          mv moodle-${{ matrix.moodle-version }}  moodle

      - name: Install Moodle Plugin 
        run: |
          cd  moodle/moodle-${{ matrix.moodle-version }}/local
          git clone ${{ matrix.plugin-repo }} 
          cd ../../..
          

      - name: Install dependancies
        run: |
          cd moodle/moodle-${{ matrix.moodle-version }}
          composer install

      - name: Run PHPUnit Tests
        run: |
          cd moodle
          vendor/bin/phpunit local/${{ matrix.plugin-name }}/tests


